@model Tabang_Hub.Utils.Lists

@{
    ViewBag.Title = "Reports";
    Layout = "~/Views/Shared/_Organization.cshtml";
}

<link rel="stylesheet" href="~/Content/vendors/iconly/bold.css">
<link rel="stylesheet" href="~/Content/css/bootstrap.css">

<style>
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        background-color: #f7f9fc;
        border-bottom: 2px solid #ebebeb;
    }

    h5, h6 {
        font-weight: 600;
    }

    .stats-icon {
        font-size: 30px;
        padding: 10px;
        background-color: rgba(0, 123, 255, 0.1);
        border-radius: 50%;
    }

    .card-body h6 {
        font-size: 16px;
    }

    .chart {
        min-height: 350px;
    }

    .recent-donators img {
        width: 40px;
        height: 40px;
        object-fit: cover;
    }

    .dashboard-section {
        margin-bottom: 2rem;
    }
</style>

<div class="page-heading">
    <h3>Reports Dashboard</h3>
    <form action="/Organization/ExportData" method="post">
        <button type="submit" class="btn btn-primary">
            Export Data to CSV
        </button>
    </form>

</div>

<div class="page-content">
    <ul class="nav nav-tabs" id="reportsTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="donation-reports-tab" data-bs-toggle="tab" data-bs-target="#donation-reports" type="button" role="tab" aria-controls="donation-reports" aria-selected="false">Donation Reports</button>
        </li>
    </ul>
    <div class="tab-content" id="reportsTabContent">
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
            <section class="row">
                <!-- Container for Total Stats -->
                <div class="col-12">
                    <div class="row">
                        <!-- Total Events, Total Donations, and Total Volunteers in same container -->
                        <div class="col-12 col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body px-3 py-4-5">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon blue me-3">
                                            <i class="iconly-boldProfile"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted">Overall Events</h6>
                                            <h6 class="font-extrabold mb-0">@Model.listOfEvents.Count()</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body px-3 py-4-5">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon green me-3">
                                            <i class="iconly-boldAdd-User"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted">Overall Donations</h6>
                                            <h6 class="font-extrabold mb-0">₱@Model.totalDonation</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body px-3 py-4-5">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon red me-3">
                                            <i class="iconly-boldBookmark"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted">Overall Volunteers</h6>
                                            <h6 class="font-extrabold mb-0">@Model.totalVolunteer</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Separate Containers for Monthly Event Summary, Recent Events, Recent Donators, Top 5 Skills -->
                <div class="col-12 col-lg-9">
                    <!-- Monthly Event Summary -->
                    <div class="dashboard-section">
                        <div class="card">
                            <div class="card-header">
                                <h4>Event History</h4>
                            </div>
                            <div class="card-body p-0">
                                <!-- Table container with fixed height and scrollable content -->
                                <div class="table-responsive" style="height: 390px;">
                                    <table class="table table-bordered mb-0">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Event Name</th>
                                                <th>Target Amount</th>
                                                <th>Total Volunteers</th>
                                                <th>Date Started</th>
                                                <th>Date Ended</th>
                                                <th>Location</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var history in Model.orgEventHistory)
                                            {
                                                if (history != null)
                                                {
                                                    <tr>
                                                        <td>@history.eventTitle</td>
                                                        <td>@history.targetAmount</td>
                                                        <td>@history.maxVolunteer</td>
                                                        <td>@(history.dateStart.HasValue ? history.dateStart.Value.ToString("MMMM dd, yyyy") : "N/A")</td>
                                                        <td>@(history.dateEnd.HasValue ? history.dateEnd.Value.ToString("MMMM dd, yyyy") : "N/A")</td>
                                                        <td>@history.location</td>
                                                        <td>
                                                            <button class="btn btn-primary btn-sm" onclick="viewEventDetails('@history.eventId')">
                                                                View
                                                            </button>
                                                        </td>
                                                    </tr>
                                                }
                                                else
                                                {
                                                    <tr>
                                                        <td colspan="7" class="text-center">No event history!</td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 Skills -->
                    <div class="dashboard-section">
                        <div class="card" style="min-height: 475px;">
                            <div class="card-header">
                                <h4>Top 5 Skills</h4>
                            </div>
                            <div class="card-body d-flex justify-content-center align-items-center">
                                <div id="chart-top-five" class="chart"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-3">
                    <!-- Recent Events -->
                    <div class="dashboard-section">
                        <div class="card mb-3" style="min-height: 470px;">
                            <div class="card-header">
                                <h4>Recent Events</h4>
                            </div>
                            <div class="card-body mt-4" style="max-height: 350px; overflow-y: auto;">
                                @if (Model.recentEvents.Any())
                                {
                                    foreach (var recent in Model.recentEvents)
                                    {
                                        <div class="recent-message d-flex align-items-center mb-3">
                                            <div class="avatar avatar-lg">
                                                <img src="~/Content/images1/faces/4.jpg" class="rounded-circle" alt="Event Image">
                                            </div>
                                            <div class="ms-3">
                                                <h5 class="mb-1">@recent.eventTitle</h5>
                                                <!-- Truncated Location -->
                                                <p class="text-muted mb-0 text-truncate" style="max-width: 200px;" data-bs-toggle="tooltip" data-bs-placement="top" title="@recent.location">
                                                    @recent.location
                                                </p>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted">No recent ongoing event.</p>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 Volunteers-->
                    <div class="dashboard-section">
                        <div class="card" style="min-height: 475px;">
                            <div class="card-header">
                                <h4>Top 5 Volunteer</h4>
                            </div>
                            <div class="card-body mt-4" style="max-height: 400px; overflow-y: auto;">
                                @if (Model.topVolunteers.Any())
                                {
                                    foreach (var volunteer in Model.topVolunteers)
                                    {
                                        <div class="recent-message d-flex align-items-center mb-3"
                                             data-bs-toggle="modal"
                                             data-bs-target="#volunteerModal-@volunteer.VolunteerId"
                                             style="cursor: pointer; transition: background-color 0.2s;"
                                             onmouseover="this.style.backgroundColor='#f8f9fa';"
                                             onmouseout="this.style.backgroundColor='';">
                                            <div class="avatar avatar-lg">
                                                <img src="~/Content/images1/faces/4.jpg" class="rounded-circle" alt="@volunteer.Name">
                                            </div>
                                            <div class="ms-3 w-100">
                                                <!-- Volunteer Name -->
                                                <h5 class="mb-1 text-md" title="Click for more details">
                                                    @volunteer.Name
                                                </h5>
                                                <p class="text-muted mb-0 text-sm">Events Participated: @volunteer.TotalEventsParticipated</p>
                                            </div>
                                        </div>

                                        <!-- Modal -->
                                        <div class="modal fade" id="volunteerModal-@volunteer.VolunteerId" tabindex="-1" aria-labelledby="volunteerModalLabel-@volunteer.VolunteerId" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-scrollable modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="volunteerModalLabel-@volunteer.VolunteerId">Participated Events by @volunteer.Name</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="row g-3">
                                                            @for (int i = 0; i < volunteer.EventIds.Count; i++)
                                                            {
                                                                var eventId = volunteer.EventIds[i];
                                                                var eventImage = volunteer.EventImages[i];
                                                                var evntList = Model.listOfEvents.FirstOrDefault(e => e.Event_Id == eventId);

                                                                if (evntList != null)
                                                                {
                                                                    <div class="col-6">
                                                                        <!-- Adjust grid size to fit 2 cards per row -->
                                                                        <div class="card" style="cursor: pointer; width: 100%; height: 300px; transition: box-shadow 0.2s;"
                                                                             onclick="window.location.href='@Url.Action("EventDetails", "Events", new { id = eventId })'"
                                                                             onmouseover="this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.2)';"
                                                                             onmouseout="this.style.boxShadow='none';">
                                                                            <!-- Use the correct image for the current event -->
                                                                            <img src="@Url.Content("~/Content/Events/" + eventImage)" class="card-img-top" alt="Event Image" style="height: 120px; object-fit: cover;">
                                                                            <div class="card-body">
                                                                                <h6 class="card-title text-truncate" title="@evntList.Event_Name">@evntList.Event_Name</h6>
                                                                                <p class="card-text small mb-1">Start: @(evntList.Start_Date.HasValue ? evntList.Start_Date.Value.ToString("MMM dd, yyyy") : "No date")</p>
                                                                                <p class="card-text small mb-1">End: @(evntList.End_Date.HasValue ? evntList.End_Date.Value.ToString("MMM dd, yyyy") : "No date")</p>
                                                                                <p class="card-text small text-muted text-truncate" title="@evntList.location">Location: @evntList.location</p>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted">No volunteers available.</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <!-- Donation Reports Tab -->
        <div class="tab-pane fade" id="donation-reports" role="tabpanel" aria-labelledby="donation-reports-tab">
            <section class="row">
                <!-- Container for Total Stats -->
                <div class="col-12">
                    <div class="row">
                        <!-- Total Events, Total Donations, and Total Volunteers in same container -->
                        <div class="col-12 col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body px-3 py-4-5">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon blue me-3">
                                            <i class="iconly-boldProfile"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted">Overall Events</h6>
                                            <h6 class="font-extrabold mb-0">@Model.listOfEvents.Count()</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body px-3 py-4-5">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon green me-3">
                                            <i class="iconly-boldAdd-User"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted">Overall Donations</h6>
                                            <h6 class="font-extrabold mb-0">₱@Model.totalDonation</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body px-3 py-4-5">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon red me-3">
                                            <i class="iconly-boldBookmark"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted">Overall Volunteers</h6>
                                            <h6 class="font-extrabold mb-0">@Model.totalVolunteer</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Separate Containers for Monthly Event Summary, Recent Events, Recent Donators, Top 5 Skills -->
                <div class="col-12 col-lg-9">
                    <!-- Monthly Event Summary -->
                    <div class="dashboard-section">
                        <div class="card">
                            <div class="card-header">
                                <h4>Event History</h4>
                            </div>
                            <div class="card-body p-0">
                                <!-- Table container with fixed height and scrollable content -->
                                <div class="table-responsive" style="height: 390px;">
                                    <table class="table table-bordered mb-0">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Event Name</th>
                                                <th>Target Amount</th>
                                                <th>Total Volunteers</th>
                                                <th>Date Started</th>
                                                <th>Date Ended</th>
                                                <th>Location</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 Skills -->
                    <div class="dashboard-section">
                        <div class="card" style="min-height: 475px;">
                            <div class="card-header">
                                <h4>Top 5 Skills</h4>
                            </div>
                            <div class="card-body d-flex justify-content-center align-items-center">
                                <div id="chart-top-five" class="chart"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-3">
                    <!-- Recent Donator-->
                    <div class="dashboard-section">
                        <div class="card mb-3" style="min-height: 470px;">
                            <div class="card-header">
                                <h4>Recent Donators</h4>
                            </div>
                            <div class="card-body mt-4" style="max-height: 350px; overflow-y: auto;">
                                @if (Model.recentDonators.Any())
                                {
                                    foreach (var recent in Model.recentDonators)
                                    {
                                        <div class="recent-message d-flex align-items-center mb-3">
                                            <div class="avatar avatar-lg">
                                                <img src="~/Content/images1/faces/4.jpg" class="rounded-circle" alt="Donor Image">
                                            </div>
                                            <div class="ms-3 w-100">
                                                <h5 class="mb-1 text-md" data-bs-toggle="tooltip" title="@recent.UserAccount.email">
                                                    @recent.UserAccount.email
                                                </h5>
                                                <p class="text-muted mb-0 text-sm">@recent.amount</p>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted">No recent donator.</p>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Recent Donators -->
                    <div class="dashboard-section">
                        <div class="card" style="min-height: 475px;">
                            <div class="card-header">
                                <h4>Top 5 Donators</h4>
                            </div>
                            <div class="card-body mt-4" style="max-height: 400px; overflow-y: auto;">
                                @if (Model.topDonators.Any())
                                {
                                    foreach (var volunteer in Model.topDonators)
                                    {
                                        <div class="recent-message d-flex align-items-center mb-3"
                                             data-bs-toggle="modal"
                                             data-bs-target="#donatorModal-@volunteer.donatorsId"
                                             style="cursor: pointer; transition: background-color 0.2s;"
                                             onmouseover="this.style.backgroundColor='#f8f9fa';"
                                             onmouseout="this.style.backgroundColor='';">
                                            <div class="avatar avatar-lg">
                                                <img src="~/Content/images1/faces/4.jpg" class="rounded-circle" alt="@volunteer.Name">
                                            </div>
                                            <div class="ms-3 w-100">
                                                <!-- Volunteer Name -->
                                                <h5 class="mb-1 text-md" title="Click for more details">
                                                    @volunteer.Name
                                                </h5>
                                                <p class="text-muted mb-0 text-sm">Total Amount Donated: @volunteer.totalAmountDonated</p>
                                            </div>
                                        </div>

                                        <!-- Modal -->
                                        <div class="modal fade" id="donatorModal-@volunteer.donatorsId" tabindex="-1" aria-labelledby="donatorModalLabel-@volunteer.donatorsId" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-scrollable modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="donatorModalLabel-@volunteer.donatorsId">Donations by @volunteer.Name</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="row g-3">
                                                            @foreach (var eventDonation in volunteer.EventDonations)
                                                            {
                                                                <div class="col-6">
                                                                    <!-- Adjust grid size to fit 2 cards per row -->
                                                                    <div class="card" style="cursor: pointer; width: 100%; height: 300px; transition: box-shadow 0.2s;"
                                                                         onclick="window.location.href='@Url.Action("EventDetails", "Events", new { id = eventDonation.EventId })'"
                                                                         onmouseover="this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.2)';"
                                                                         onmouseout="this.style.boxShadow='none';">
                                                                        <img src="@Url.Content("~/Content/Events/" + eventDonation.EventImage)" class="card-img-top" alt="Event Image" style="height: 120px; object-fit: cover;">
                                                                        <div class="card-body">
                                                                            <h6 class="card-title text-truncate" title="@eventDonation.EventName">@eventDonation.EventName</h6>
                                                                            <p class="card-text small mb-1">Amount Donated: @eventDonation.AmountDonated.ToString("C")</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted">No Donators available.</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>


<script src="~/Content/vendors/apexcharts/apexcharts.js"></script>
<script src="~/Content/js1/pages/dashboard.js"></script>
<script type="text/javascript">

    document.addEventListener('DOMContentLoaded', function () {
        // Extract the top 5 skills from the server data
        var skills = [];
        var counts = [];

        @foreach (var skill in Model.totalSkills.OrderByDescending(x => x.Value).Take(5))
        {
            <text>
                skills.push("@skill.Key");    // Skill name
                counts.push(@skill.Value);    // Skill count
            </text>;
        }

        // ApexCharts Pie Chart Configuration
        var options = {
            chart: {
                type: 'donut',    // Donut chart type
                height: 300
            },
            series: counts,       // Skill counts as data
            labels: skills,       // Skill names as labels
            plotOptions: {
                pie: {
                    donut: {
                        size: '70%'    // Donut inner circle size
                    }
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val) {
                    return val.toFixed(1) + "%";  // Format percentages
                }
            },
            legend: {
                position: 'bottom'
            },
            colors: ['#008FFB', '#00E396', '#FEB019', '#FF4560', '#775DD0'], // Colors for each slice
        };

        var chart = new ApexCharts(document.querySelector("#chart-top-five"), options);
        chart.render();
    });

      document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
